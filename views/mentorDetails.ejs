<%- include partials/innerheader %>
 <!-- Page Content Start -->

<div class="app_main">
  <%- include partials/innersidebar %>
<div class="app_content">
  <div class="dsbrd_container">
    <div class="trade_dtl_wrapper dsbrd_center_wrapper">
      <div class="trade_dtl_head">
        <a href="/dashboard"><button class="btn back_btn"><i class="fas fa-arrow-left"></i></button></a>
       <!--  <button class="btn cmn_btn btn_small btn_primary">View AI Trend</button> -->
      </div>
      <div class="trade_dtl_box tips_bx buy_bg" id="idOfElement">
        <div class="tips_bx_head">
          <div class="tips_bx_author author_bx">
            <img onerror="handleError(this);" id="MentorUserImage" src="#" alt="images">
            <div class="author_bx_txt">
              <h2 id="MentorUser"></h2>
              <!-- <h3>2 mins ago</h3> -->
            </div>
          </div>
          <div class="tips_bx_amount">
            <h2 id="currentprice"></h2>
            <p>AT TIME OF TIP : <span id="TipNumber"></span> | Change <span id="changepoint"></span></p>
          </div>
        </div>
        
        <div class="tips_bx_cmpny">
          <div class="tips_bx_cmpny_name">
            <span class="bs_btn buy_btn" id="suggestion"></span>                       
            <!-- <h2 id="CompanySymbol"></h2>&nbsp;<p>(</p><h2><span id="skComnyNames"></span></h2><p>)</p> -->
             <h2><em class="only_id_use" id="CompanySymbol"></em> <span id="skComnyNames"></span></h2>
          </div>     
        <!--   <div class="tips_bx_txt">
            <span id="skComnyNames"></span>
          </div> -->
          <div class="tips_bx_cmpny_states">
            <ul>
              <li>
                <h3>Entry</h3>
                <h4 id="entrypoint"></h4>
              </li>
              <li>
                <h3>Exit</h3>
                <h4><span class="color_buy" id="exitpoint"></span></h4>
              </li>
              <li>
                <h3>Stop</h3>
                <h4 id="stoppoint"></h4>
              </li>
              
            </ul>
          </div>
        </div>
        <div class="tips_bx_txt">
          <p id="commentDetail"></p>
        </div>
        <div class="tips_bx_social">
          <ul>
            <li>
              <a href="#">
                <img src="images/tips-comment-icon.png" alt="images"><span id="commentcount"></span>             
              </a>
            </li>
            <li onclick="pinFunction('<%=tipsIds%>')" style="color: #000;">
              <a href="#">
                <img alt="images" id="imgstatus"><p id="StatusPin" style="display:none;"></p>  Save
              </a>
            </li>
            <li onclick="likeFunction('<%=tipsIds%>')" style="color: #000;">
              <a href="#">
                <img alt="images" id="likeimgstatus"><p id="StatusLike" style="display:none;"></p><span id="likecount"></span><p id="textvalLike" style="display:none;"></p>
              </a>
            </li>
            <!-- <li>
              <div class="dropdown msg_option_dropdown">
                <a class="btn dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <img src="images/tips-more-icon.png" alt="images"> More
                </a>
                <div class="dropdown-menu dropdown-menu-right">
                  <ul>
                    <li><span><i class="fas fa-folder-open"></i></span> Archive all</li>
                    <li><span><i class="fas fa-check-double"></i></span> Mark all as read</li>
                  </ul>
                </div>
              </div>
            </li>  -->
          </ul>
        </div>
        <div id="commentdemo"> </div>
        <div class="review_area">
          <div class="post_review_bx">
            <h2>Leave a Comment</h2>
            <div class="post_review_bx_in">
              <img id="myImguser" alt="images">
              <textarea class="form-control" placeholder="Write a comment" name="review" id="test"></textarea>
              <button class="btn cmn_btn btn_small btn_secondary" id="postbtn">Post Comment</button>
            </div>
           <!--<div class="post_review_bx">
            <h2>Leave a review</h2>
            <div class="post_review_bx_in">
              <img src="images/user.png" alt="images">
              <textarea class="form-control" placeholder="Write a comment" name="review"></textarea>
              <button class="btn cmn_btn btn_small btn_secondary">Post Review</button>
            </div>
          </div>
          <div class="review_bx">
            <div class="review_bx_head">
              <div class="author_bx">
                <img src="images/user1.png" alt="images">
                <div class="author_bx_txt">
                  <h2>Williams Park <span class="author_tag"><img src="images/pin-buy.png" alt="images"> (Author Comment)</span></h2>
                  <h3>2 mins ago</h3>
                </div>
              </div>
            </div>
            <div class="review_bx_txt">
              <p>Zwei flinke Boxer jagen die quirlige Eva und ihren Mops durch Sylt. Franz jagt im komplett verwahrlosten Taxi quer durch Bayern. Zwölf Boxkämpfer jagen Viktor quer über den großen Sylter Deich. Vogel Quax zwickt Johnys Pferd Bim. Sylvia wagt quick den Jux bei Pforzheim. Polyfon zwitschernd aßen Mäxchens Vögel Rüben, Joghurt und Quark. "Fix, Schwyz!" quäkt Jürgen blöd vom Paß. Victor jagt zwölf Boxkämpfer quer über den großen Sylter Deich. Falsches Üben von.</p>
            </div>
            <div class="tips_bx_social review_bx_btm">
              <ul>
                <li>
                  <a href="#">
                    <img src="images/tips-comment-icon.png" alt="images">
                    21 Comments
                  </a>
                </li>
                <li>
                  <a href="#">
                    <img src="images/tips-like-icon.png" alt="images">
                    6 Likes
                  </a>
                </li>
              </ul>
            </div>
          </div>
          <div class="review_bx">
            <div class="review_bx_head">
              <div class="author_bx">
                <img src="images/user2.png" alt="images">
                <div class="author_bx_txt">
                  <h2>Williams Park <span class="author_tag"><img src="images/pin-buy.png" alt="images"> (Author Comment)</span></h2>
                  <h3>2 mins ago</h3>
                </div>
              </div>
            </div>
            <div class="review_bx_txt">
              <p>Zwei flinke Boxer jagen die quirlige Eva und ihren Mops durch Sylt. Franz jagt im komplett verwahrlosten Taxi quer durch Bayern. Zwölf Boxkämpfer jagen Viktor quer über den großen Sylter Deich. Vogel Quax zwickt Johnys Pferd Bim. Sylvia wagt quick den Jux bei Pforzheim.</p>
            </div>
            <div class="tips_bx_social review_bx_btm">
              <ul>
                <li>
                  <a href="#">
                    <img src="images/tips-comment-icon.png" alt="images">
                    21 Comments
                  </a>
                </li>
                <li>
                  <a href="#">
                    <img src="images/tips-like-icon.png" alt="images">
                    6 Likes
                  </a>
                </li>
              </ul>
            </div>
          </div>
          <div class="review_bx">
            <div class="review_bx_head">
              <div class="author_bx">
                <img src="images/user3.png" alt="images">
                <div class="author_bx_txt">
                  <h2>Martin Methew</h2>
                  <h3>2 mins ago</h3>
                </div>
              </div>
            </div>
            <div class="review_bx_txt">
              <p>Zwei flinke Boxer jagen die quirlige Eva und ihren Mops durch Sylt. Franz jagt im komplett verwahrlosten Taxi quer durch Bayern. Zwölf Boxkämpfer jagen Viktor quer über den großen Sylter Deich. Vogel Quax zwickt Johnys Pferd Bim. Sylvia wagt quick den Jux bei Pforzheim.
              </p>
            </div>
            <div class="tips_bx_social review_bx_btm">
              <ul>
                <li>
                  <a href="#">
                    <img src="images/tips-comment-icon.png" alt="images">
                    21 Comments
                  </a>
                </li>
                <li>
                  <a href="#">
                    <img src="images/tips-like-icon.png" alt="images">
                    6 Likes
                  </a>
                </li>
              </ul>
            </div>
            <div class="reply_bx">
              <div class="post_review_bx">
                <h2>Post your Reply</h2>
                <div class="post_review_bx_in">
                  <img src="images/user.png" alt="images">
                  <textarea class="form-control" placeholder="Write a comment" name="review"></textarea>
                  <button class="btn cmn_btn btn_small btn_secondary">Post Review</button>
                </div>
              </div>
              <div class="review_bx">
                <div class="review_bx_head">
                  <div class="author_bx">
                    <img src="images/user4.png" alt="images">
                    <div class="author_bx_txt">
                      <h2>Williams Park <span class="author_tag"><img src="images/pin-buy.png" alt="images"> (Author Comment)</span></h2>
                      <h3>2 mins ago</h3>
                    </div>
                  </div>
                </div>
                <div class="review_bx_txt">
                  <p>Zwei flinke Boxer jagen die quirlige Eva und ihren Mops durch Sylt. Franz jagt im komplett verwahrlosten Taxi quer durch Bayern. Zwölf Boxkämpfer jagen Viktor quer über den großen Sylter Deich. Vogel Quax zwickt Johnys Pferd Bim. Sylvia wagt quick den Jux bei Pforzheim. Polyfon zwitschernd aßen Mäxchens Vögel Rüben, Joghurt und Quark. "Fix, Schwyz!" quäkt Jürgen blöd vom Paß. Victor jagt zwölf Boxkämpfer quer über den großen Sylter Deich. Falsches Üben von.</p>
                </div>
                <div class="tips_bx_social review_bx_btm">
                  <ul>
                    <li>
                      <a href="#">
                        <img src="images/tips-comment-icon.png" alt="images">
                        21 Comments
                      </a>
                    </li>
                    <li>
                      <a href="#">
                        <img src="images/tips-like-icon.png" alt="images">
                        6 Likes
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div> -->
        </div>
      </div>
    </div>
  </div>
</div>
</div>
<!-- Page Content Start -->
<%- include partials/innerfooter %>

<script type="text/javascript">
var default_avatar = 'images/userIcon.png';
 
function handleError(image) {
    image.src = default_avatar;
    return true;
}

  var sData = localStorage.getItem('allTokenData');
  var storageData= JSON.parse(sData);
  var LoggedInId = storageData.uid;

  var tokens = storageData.tokendata;

  var tipIds = "<%=tipsIds%>";

  // alert(tipIds);

  var formdata = {tipId: tipIds};
  $.ajax({
        type: 'POST',
        url: 'https://apis.tradetipsapp.com/api/tip/getAllTipFeatureDetailsByTipId',
        headers: {
          Authorization: 'Bearer '+ tokens,
           },
        data: formdata,
      success: function(data) {
     
          // console.log(data);    

            const dataResult = data;

                // alert(dataResult.userPinStatus);

                 if(dataResult.userPinStatus == true){

                    // alert("true");

                    document.getElementById("imgstatus").src = "/savetip.png";

                  }else{

                    // alert("false");
                     
                     document.getElementById("imgstatus").src = "images/tips-save-icon.png";
                  }

                  if(dataResult.userLikeStatus == true){

                     document.getElementById("likeimgstatus").src = "/unnamed.png";

                  }else{

                    document.getElementById("likeimgstatus").src = "images/tips-like-icon.png";

                  }

                  document.getElementById("MentorUser").textContent = dataResult.tip.appUser.userName;
                  document.getElementById("MentorUserImage").src = "https://apis.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+dataResult.tip.appUser.id;
                  document.getElementById("TipNumber").textContent = "$"+parseFloat(dataResult.tip.createTipPrice).toFixed(2);
                  document.getElementById("CompanySymbol").textContent = dataResult.tip.stockName;
                  document.getElementById("entrypoint").textContent = "$"+parseFloat(dataResult.tip.entryPoint).toFixed(2);
                  document.getElementById("stoppoint").textContent = "$"+parseFloat(dataResult.tip.stopPoint).toFixed(2);
                  document.getElementById("exitpoint").textContent = "$"+parseFloat(dataResult.tip.exitPoint).toFixed(2);
                  document.getElementById("suggestion").textContent = dataResult.tip.stockSuggestion;
                  // console.log(dataResult.commentCount);
                  document.getElementById("commentcount").textContent = dataResult.commentCount +" Comments";
                  document.getElementById("likecount").textContent = dataResult.likeCount +" Likes";

                   document.getElementById("textvalLike").textContent = dataResult.likeCount;

                  
                  document.getElementById("commentDetail").textContent = dataResult.tip.comment;

                   document.getElementById("myImguser").src = "https://apis.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+LoggedInId;

                  document.getElementById("StatusPin").textContent = dataResult.userPinStatus;

                  document.getElementById("StatusLike").textContent = dataResult.userLikeStatus;

                  // alert(dataResult.tip.stockSuggestion);

                  if(dataResult.tip.stockSuggestion == "Buy" ){

                    document.getElementById('idOfElement').className = 'trade_dtl_box tips_bx buy_bg';
                    document.getElementById('suggestion').className = 'bs_btn buy_btn';

                  }else{

                    document.getElementById('idOfElement').className = 'trade_dtl_box tips_bx sell_bg';
                    document.getElementById('suggestion').className = 'bs_btn sell_btn';

                  }

                 


                  $.get('https://cloud.iexapis.com/stable/stock/market/batch?types=quote&token=pk_dd324da3fb5f4428a47b05ab12f23ce2&symbols='+ dataResult.tip.stockName , function(d) {

                          var count = Object.keys(d).length;
                          Object.keys(d).map((keyName, key) => {
                             $("#currentprice").text("$"+d[keyName].quote.latestPrice);
                            $("#skComnyNames").text(d[keyName].quote.companyName);
                            var latestPrice = d[keyName].quote.latestPrice;
                            var createTipPrice = Number(dataResult.tip.createTipPrice);
                            var changeprice = latestPrice - createTipPrice
                            $("#changepoint").text("$"+parseFloat(changeprice).toFixed(2));

                          });
                        });

                    var formdata = {tipId: tipIds,offset: 0, limit: 100};
                     $.ajax({
                    type: 'POST',
                    url: 'https://apis.tradetipsapp.com/api/comment/getCommentsByTipIdPagination',
                    headers: {
                      Authorization: 'Bearer '+ tokens,
                       },
                    data: formdata,
                    success: function(data) {
                      var dataResult1 = data;
                      //console.log(dataResult1);          
                      //console.log(dataResult1.length);
                      if(dataResult1.length != 0) {
                        for(i=0;i<dataResult1.length;i++){

                            var text = '<div class="review_bx"><div class="review_bx_head"><div class="author_bx"><img src="https://apis.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId='+dataResult1[i].appUser.id+'" alt="images"><div class="author_bx_txt"><h2 style="display: inline-block";>'+dataResult1[i].appUser.userName+'<span class="author_tag"><i class="fa fa-flag" aria-hidden="true" onclick = "flagclick(this.id)" id = "'+ dataResult1[i].id +'" style="color:white;"></i></span></h2></div></div></div><div class="review_bx_txt"><p>'+dataResult1[i].commentDetails+'</p></div>';
                            $("#commentdemo").append(text);
                       }
                       }
                      // } else{
                      //   document.getElementById('demo').style.display = 'none';


                      // }  
              
                       
                    }
                  });
                           
                  



                   // document.getElementById("description1").value = dataResult.descriptionOne;
                  // // document.getElementById("description2").value = null;
                  // document.getElementById("frequency").value = dataResult.frequency;
                  // document.getElementById("price").value = dataResult.price;
         
               
       }
       
  });

//  function imgError(image) {
//     image.onerror = "";
//     image.src = "images/userIcon.png";
//     return true;
// }

 $('#postbtn').on('click', function() {
      var commentval = $('#test').val();
      if(commentval!=""){
          var formdata = new FormData();
          formdata.append("tipId", tipIds);
          formdata.append("commentDetails", commentval);
          formdata.append("status", "Pending");
          formdata.append("userid", LoggedInId);
          var requestOptions = {
            method: 'POST',
            headers: {
                    Authorization: 'Bearer '+ tokens
                   },
            body: formdata,
            redirect: 'follow'};
            fetch("https://apis.tradetipsapp.com/api/comment/addCommentOnTip", requestOptions)
           .then(response => response.json())
           .then(result => {
                //console.log("calling val" +result);
                var datak = JSON.stringify(result);
                //console.log(datak);
                var dataResultp = JSON.parse(datak);
                //console.log(dataResultp);
                //console.log(tipIds);
                var formdata = {tipId: tipIds,offset: 0, limit: 100};

                $.ajax({
                      type: 'POST',
                      url: 'https://apis.tradetipsapp.com/api/comment/getCommentsByTipIdPagination',
                      headers: {
                         Authorization: 'Bearer '+ tokens,
                       },
                      data: formdata,
                      success: function(data) {
         
                      var texts = '<div class="review_bx"><div class="review_bx_head"><div class="author_bx"><img src="https://apis.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId='+data[0].appUser.id+'" alt="images"><div class="author_bx_txt"><h2 style="display: inline-block";>'+data[0].appUser.userName+'<span class="author_tag"><i class="fa fa-flag" aria-hidden="true" onclick = "flagclick(this.id)" id = "'+ data[0].id +'" style="color:white;"></i></span></h2></div></div></div><div class="review_bx_txt"><p>'+data[0].commentDetails+'</p></div>';
                      $("#commentdemo").prepend(texts);
                      }
                    });

                 var formdata = {tipId: tipIds};
                  $.ajax({
                        type: 'POST',
                        url: 'https://apis.tradetipsapp.com/api/tip/getAllTipFeatureDetailsByTipId',
                        headers: {
                          Authorization: 'Bearer '+ tokens,
                           },
                        data: formdata,
                      success: function(data) {

                            const dataResult = data;
                            var comnt = (dataResult.commentCount);
                            console.log(comnt);

                            document.getElementById("commentcount").textContent = comnt+" Comments";
                          }
                        });
               

       })
      .catch(error => console.log('error', error));
      document.getElementById("test").value = "";



     

            }
            else{
              alert('Please fill the field !');
            }
          });

function flagclick(e) {
  //alert("yes");
  //console.log(e);
//console.log(LoggedInId);
var formdata = new FormData();
formdata.append("commentId", e);
formdata.append("userId", LoggedInId);
formdata.append("isFlag", "true");
formdata.append("flagReason", "");
//console.log(formdata);
var requestOptions = {
  method: 'POST',
  headers: {
               Authorization: 'Bearer '+ tokens
                },
  body: formdata,
  redirect: 'follow'
};
// console.log(requestOptions);
fetch("https://apis.tradetipsapp.com/api/tipCommentFlag/addCommentFlag", requestOptions)
.then(response => response.json())
.then(result => {
// console.log("calling val" +result);
                var datak = JSON.stringify(result);
                console.log(datak);
                var dataResultp = JSON.parse(datak);
                console.log(dataResultp);
                var flagstatus = dataResultp.status;
                //console.log(flagstatus);
                if (flagstatus=="true"){
                  //alert("Flag has been added for comment.");
                   $(".successmsg").html('<span>Flag has been added for comment.</span>');
                    setTimeout(function(){$(".successmsg").empty()}, 3000);
                }
                else{
                  //alert("This user has already submitted flag for this comment !!!");
                  $(".successmsg").html('<span>This user has already submitted flag for this comment !!!</span>');
                    setTimeout(function(){$(".successmsg").empty()}, 3000);
                }

              })

}

function pinFunction(e) {

  //alert(e);
 
  var formdata = {tipId : e};

  // var imgCount = $("#textval"+ e).text();

  var userdataPin = $("#StatusPin").text();

 // alert(userdataPin);

  if(userdataPin == "true"){

    $.ajax({
        type: 'POST',
        url: 'https://apis.tradetipsapp.com/api/tipFeature/tipUnPinForUser',
        headers: {
          Authorization: 'Bearer '+ tokens,
           },
        data: formdata,
      success: function(data) {
     
        // var valss = parseInt(imgCount) - 1;

        // $("#textval").text(valss);

        $("#StatusPin").text("false");

        // $("#imgstatus").attr("src","show.jpeg");

        document.getElementById("imgstatus").src="images/tips-save-icon.png";


        }

      });

  }else{
    $.ajax({
        type: 'POST',
        url: 'https://apis.tradetipsapp.com/api/tipFeature/tipPinForUser',
        headers: {
          Authorization: 'Bearer '+ tokens,
           },
        data: formdata,
      success: function(data) {
      
        // var valss = parseInt(imgCount) + 1;

        // $("#textval"+e).text(valss);

        $("#StatusPin").text("true");


        // $("#imgstatus").attr("src","savetip.png");


        document.getElementById("imgstatus").src="savetip.png";



        }

      });
  }



}

function likeFunction(e) {

  // alert(e);
 
  var formdata = {tipId : e};

  var imgCount = $("#textvalLike").text();

  // alert(imgCount);

  var userdataPin = $("#StatusLike").text();

  if(userdataPin == "true"){
    // alert("equal true");

    $.ajax({
        type: 'POST',
        url: 'https://apis.tradetipsapp.com/api/tipFeature/tipUnLikeForUser',
        headers: {
          Authorization: 'Bearer '+ tokens,
           },
        data: formdata,
      success: function(data) {
     
        // var valss = parseInt(imgCount) - 1;

        // $("textvalLike").text(valss);

        // $("#likecount").text(valss + " Likes");

        $("#StatusLike").text("false");

        $("#likeimgstatus").attr("src","images/tips-like-icon.png");

        window.location.reload("/");


        }

      });

  }else{
    // alert("equal false");
    $.ajax({
        type: 'POST',
        url: 'https://apis.tradetipsapp.com/api/tipFeature/tipLikeForUser',
        headers: {
          Authorization: 'Bearer '+ tokens,
           },
        data: formdata,
      success: function(data) {
      
        // var valss = parseInt(imgCount) + 1;

        // $("textvalLike").text(valss);

        // $("#likecount").text(valss + " Likes");

        $("#StatusLike").text("true");


        $("#likeimgstatus").attr("src","unnamed.png");

         window.location.reload("/");


        }

      });
  }


}

// function likeFunction(e) {

//   //alert(e);
 
//   var formdata = {tipId : e};

//   // var imgCount = $("#textval"+ e).text();

//   var userdataLike = $("#StatusLike").text();

//  // alert(userdataPin);

//   if(userdataLike == "true"){

//     $.ajax({
//         type: 'POST',
//         url: 'https://apis.tradetipsapp.com/api/tipFeature/tipUnLikeForUser',
//         headers: {
//           Authorization: 'Bearer '+ tokens,
//            },
//         data: formdata,
//       success: function(data) {
     
//         // var valss = parseInt(imgCount) - 1;

//         // $("#textval").text(valss);

//         $("#StatusLike").text("false");

//         // $("#imgstatus").attr("src","show.jpeg");

//         document.getElementById("likeimgstatus").src="images/tips-like-icon.png";


//         }

//       });

//   }else{
//     $.ajax({
//         type: 'POST',
//         url: 'https://apis.tradetipsapp.com/api/tipFeature/tipLikeForUser',
//         headers: {
//           Authorization: 'Bearer '+ tokens,
//            },
//         data: formdata,
//       success: function(data) {
      
//         // var valss = parseInt(imgCount) + 1;

//         // $("#textval"+e).text(valss);

//         $("#StatusLike").text("true");


//         // $("#imgstatus").attr("src","savetip.png");


//         document.getElementById("likeimgstatus").src="unnamed.png";



//         }

//       });
//   }



// }



  </script>

